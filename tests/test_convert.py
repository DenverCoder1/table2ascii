import pytest

from table2ascii import table2ascii as t2a
from table2ascii.exceptions import (
    BodyColumnCountMismatchError,
    FooterColumnCountMismatchError,
    NoHeaderBodyOrFooterError,
)


def test_header_body_footer():
    text = t2a(
        header=["#", "G", "H", "R", "S"],
        body=[["1", "30", "40", "35", "30"], ["2", "30", "40", "35", "30"]],
        footer=["SUM", "130", "140", "135", "130"],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘  #  â•‘  G     H     R     S  â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘  1  â•‘ 30    40    35    30  â•‘\n"
        "â•‘  2  â•‘ 30    40    35    30  â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ SUM â•‘ 130   140   135   130 â•‘\n"
        "â•šâ•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_body_footer():
    text = t2a(
        body=[["1", "30", "40", "35", "30"], ["2", "30", "40", "35", "30"]],
        footer=["SUM", "130", "140", "135", "130"],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘  1  â•‘ 30    40    35    30  â•‘\n"
        "â•‘  2  â•‘ 30    40    35    30  â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ SUM â•‘ 130   140   135   130 â•‘\n"
        "â•šâ•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_header_body():
    text = t2a(
        header=["#", "G", "H", "R", "S"],
        body=[["1", "30", "40", "35", "30"], ["2", "30", "40", "35", "30"]],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ # â•‘ G    H    R    S  â•‘\n"
        "â•Ÿâ”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ 1 â•‘ 30   40   35   30 â•‘\n"
        "â•‘ 2 â•‘ 30   40   35   30 â•‘\n"
        "â•šâ•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_header_footer():
    text = t2a(
        header=["#", "G", "H", "R", "S"],
        footer=["SUM", "130", "140", "135", "130"],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘  #  â•‘  G     H     R     S  â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•Ÿâ”€â”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ SUM â•‘ 130   140   135   130 â•‘\n"
        "â•šâ•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_header():
    text = t2a(
        header=["#", "G", "H", "R", "S"],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ # â•‘ G   H   R   S â•‘\n"
        "â•Ÿâ”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•šâ•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_body():
    text = t2a(
        body=[["1", "30", "40", "35", "30"], ["2", "30", "40", "35", "30"]],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ 1 â•‘ 30   40   35   30 â•‘\n"
        "â•‘ 2 â•‘ 30   40   35   30 â•‘\n"
        "â•šâ•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_footer():
    text = t2a(
        footer=["SUM", "130", "140", "135", "130"],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•Ÿâ”€â”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ SUM â•‘ 130   140   135   130 â•‘\n"
        "â•šâ•â•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_no_header_body_or_footer():
    with pytest.raises(NoHeaderBodyOrFooterError):
        t2a()


def test_header_footer_unequal():
    with pytest.raises(FooterColumnCountMismatchError):
        t2a(
            header=["H", "R", "S"],
            footer=["SUM", "130", "140", "135", "130"],
            first_col_heading=True,
        )


def test_header_body_unequal():
    with pytest.raises(BodyColumnCountMismatchError):
        t2a(
            header=["#", "G", "H", "R", "S"],
            body=[
                ["0", "45", "30", "32", "28"],
                ["1", "30", "40", "35", "30", "36"],
                ["2", "30", "40", "35", "30"],
            ],
            first_col_heading=True,
        )


def test_footer_body_unequal():
    with pytest.raises(BodyColumnCountMismatchError):
        t2a(
            body=[
                ["0", "45", "30", "32", "28"],
                ["1", "30", "40", "35", "30"],
                ["2", "30", "40", "35", "30"],
            ],
            footer=["SUM", "130", "140", "135", "130", "36"],
            first_col_heading=True,
        )


def test_empty_header():
    text = t2a(
        header=[],
        body=[["1", "30", "40", "35", "30"], ["2", "30", "40", "35", "30"]],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ 1 â•‘ 30   40   35   30 â•‘\n"
        "â•‘ 2 â•‘ 30   40   35   30 â•‘\n"
        "â•šâ•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_empty_body():
    text = t2a(
        header=["#", "G", "H", "R", "S"],
        body=[],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ # â•‘ G   H   R   S â•‘\n"
        "â•Ÿâ”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•šâ•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_numeric_data():
    text = t2a(
        header=[1, "G", "H", "R", "S"],
        body=[[1, 2, 3, 4, 5]],
        footer=["A", "B", 1, 2, 3],
        column_widths=[4, 5, 5, 4, 5],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ 1  â•‘  G     H    R     S  â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ 1  â•‘  2     3    4     5  â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ A  â•‘  B     1    2     3  â•‘\n"
        "â•šâ•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_stringifiable_classes():
    class Foo:
        def __str__(self):
            return "Foo"

    text = t2a(
        header=[1, Foo(), None],
        body=[[1, Foo(), None]],
        footer=[1, Foo(), None],
        first_col_heading=True,
    )
    expected = (
        "â•”â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ 1 â•‘ Foo   None â•‘\n"
        "â•Ÿâ”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ 1 â•‘ Foo   None â•‘\n"
        "â•Ÿâ”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ 1 â•‘ Foo   None â•‘\n"
        "â•šâ•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_multiline_cells():
    text = t2a(
        header=["Multiline\nHeader\nCell", "G", "Two\nLines", "R", "S"],
        body=[[1, "Alpha\nBeta\nGamma", 3, 4, "One\nTwo"]],
        footer=["A", "Footer\nBreak", 1, "Second\nCell\nBroken", 3],
    )
    expected = (
        "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ Multiline     G       Two      R       S  â•‘\n"
        "â•‘  Header              Lines                â•‘\n"
        "â•‘   Cell                                    â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘     1       Alpha      3       4      One â•‘\n"
        "â•‘              Beta                     Two â•‘\n"
        "â•‘             Gamma                         â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘     A       Footer     1     Second    3  â•‘\n"
        "â•‘             Break             Cell        â•‘\n"
        "â•‘                              Broken       â•‘\n"
        "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_east_asian_wide_characters_and_zero_width_wcwidth():
    # using wcwidth.wcswidth() to count the number of characters
    text = t2a(
        header=["#\u200b", "ğŸ¦", "ğŸ¦¡", "ğŸ¦…", "ğŸ"],
        body=[["ğŸ’»", "âœ…", "âœ…", "âŒ", "âŒ"]],
        footer=["ğŸ¥", "æ—¥", "æœˆ", "ç«", "æ°´"],
        first_col_heading=True,
    )
    text2 = t2a(
        header=["#\u200b", "ğŸ¦", "ğŸ¦¡", "ğŸ¦…", "ğŸ"],
        body=[["ğŸ’»", "âœ…", "âœ…", "âŒ", "âŒ"]],
        footer=["ğŸ¥", "æ—¥", "æœˆ", "ç«", "æ°´"],
        first_col_heading=True,
        use_wcwidth=True,
    )
    expected = (
        "â•”â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ #â€‹  â•‘ ğŸ¦   ğŸ¦¡   ğŸ¦…   ğŸ â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ ğŸ’» â•‘ âœ…   âœ…   âŒ   âŒ â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ ğŸ¥ â•‘ æ—¥   æœˆ   ç«   æ°´ â•‘\n"
        "â•šâ•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected
    assert text2 == expected


def test_east_asian_wide_characters_and_zero_width_no_wcwidth():
    # using len() to count the number of characters
    text = t2a(
        header=["#\u200b", "ğŸ¦", "ğŸ¦¡", "ğŸ¦…", "ğŸ"],
        body=[["ğŸ’»", "âœ…", "âœ…", "âŒ", "âŒ"]],
        footer=["ğŸ¥", "æ—¥", "æœˆ", "ç«", "æ°´"],
        first_col_heading=True,
        use_wcwidth=False,
    )
    expected = (
        "â•”â•â•â•â•â•¦â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘ #â€‹ â•‘ ğŸ¦   ğŸ¦¡   ğŸ¦…   ğŸ â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ ğŸ’»  â•‘ âœ…   âœ…   âŒ   âŒ â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â•«â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘ ğŸ¥  â•‘ æ—¥   æœˆ   ç«   æ°´ â•‘\n"
        "â•šâ•â•â•â•â•©â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected


def test_multiline_cells_with_wrappable_lines():
    text = t2a(
        header=["Test"],
        body=[["Line One...\nSecond Line...\nLineNumThree\nLineFour\nFive FinalLine"]],
    )
    expected = (
        "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n"
        "â•‘      Test      â•‘\n"
        "â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢\n"
        "â•‘  Line One...   â•‘\n"
        "â•‘ Second Line... â•‘\n"
        "â•‘  LineNumThree  â•‘\n"
        "â•‘    LineFour    â•‘\n"
        "â•‘ Five FinalLine â•‘\n"
        "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    )
    assert text == expected
